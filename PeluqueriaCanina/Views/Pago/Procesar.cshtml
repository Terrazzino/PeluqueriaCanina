@model PeluqueriaCanina.Models.ClasesDePago.Pago

@{
    ViewData["Title"] = "Procesar Pago";
    var turno = ViewBag.Turno as PeluqueriaCanina.Models.ClasesDeTurno.Turno;
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">

            <!-- Card Principal -->
            <div class="glass-card">

                <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                    <h3 class="text-warning mb-0">Procesar Pago</h3>

                    <a href="/Turno/Index" class="btn btn-outline-light btn-sm rounded-pill px-3">
                        <i class="bi bi-arrow-left"></i> Volver
                    </a>
                </div>

                <!-- Información del Turno -->
                <div class="mb-4 p-3 rounded" style="background: rgba(255,255,255,0.06); border-left: 3px solid #ffc107;">
                    <h5 class="text-warning">Detalles del Turno</h5>

                    <div class="row mt-3">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Mascota:</strong> @turno.Mascota.Nombre</p>
                            <p class="mb-1"><strong>Servicio:</strong> @turno.Servicio.NombreDelServicio</p>
                            <p class="mb-1"><strong>Peluquero:</strong> @turno.Peluquero.Nombre @turno.Peluquero.Apellido</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Fecha:</strong> @turno.FechaHora.ToString("dd/MM/yyyy")</p>
                            <p class="mb-1"><strong>Hora:</strong> @turno.FechaHora.ToString("HH:mm")</p>
                            <p class="mb-1">
                                <strong>Estado:</strong>
                                <span class="badge bg-warning text-dark px-3 py-2">@turno.Estado</span>
                            </p>
                        </div>
                    </div>

                    <hr />

                    <h4 class="text-end mb-0">
                        <strong>Total:</strong>
                        <span class="text-success">$@turno.Precio.ToString("N2")</span>
                    </h4>
                </div>

                <!-- Formulario -->
                <form id="formPago">
                    @Html.AntiForgeryToken()

                    <input type="hidden" id="TurnoId" name="TurnoId" value="@turno.Id" />
                    <input type="hidden" id="Monto" name="Monto" value="@turno.Precio" />

                    <div class="mb-3">
                        <label for="MetodoPago" class="form-label text-light">
                            Método de Pago *
                        </label>
                        <select id="MetodoPago" name="MetodoPago" class="form-select dark-input" required>
                            <option value="">Seleccione un método</option>
                            <option value="0">Efectivo</option>
                            <option value="1">Tarjeta de Débito</option>
                            <option value="2">Tarjeta de Crédito</option>
                            <option value="3">Mercado Pago</option>
                            <option value="4">Transferencia Bancaria</option>
                        </select>
                    </div>

                    <!-- Campos para tarjeta -->
                    <div id="camposTarjeta" style="display:none;">
                        <div class="mb-3">
                            <label for="Ultimos4Digitos" class="form-label text-light">Últimos 4 dígitos</label>
                            <input type="text" class="form-control dark-input"
                                   id="Ultimos4Digitos" name="Ultimos4Digitos"
                                   maxlength="4" pattern="\d{4}"
                                   placeholder="1234" />
                            <small class="text-muted">Solo referencia, no guardamos datos completos</small>
                        </div>
                    </div>

                    <!-- Campo para número de transacción -->
                    <div id="campoTransaccion" style="display:none;">
                        <div class="mb-3">
                            <label class="form-label text-light">Número de Transacción</label>
                            <input type="text" class="form-control dark-input"
                                   id="NumeroTransaccion" name="NumeroTransaccion"
                                   maxlength="100" placeholder="Ej: MP-12345678" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-light">Observaciones</label>
                        <textarea class="form-control dark-input"
                                  id="Observaciones" name="Observaciones"
                                  rows="3" maxlength="500"
                                  placeholder="Notas adicionales"></textarea>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-warning text-dark fw-bold btn-lg rounded-pill">
                            Confirmar Pago ($@turno.Precio.ToString("N2"))
                        </button>

                        <a href="/Turno/Index" class="btn btn-outline-light rounded-pill">
                            Volver a Mis Turnos
                        </a>
                    </div>
                </form>

            </div>

            <!-- Seguridad -->
            <div class="glass-card mt-4 p-3">
                <h6 class="text-warning"><i class="bi bi-shield-check"></i> Información de Seguridad</h6>
                <ul class="small text-muted mb-0">
                    <li>No guardamos información completa de tarjetas</li>
                    <li>Pagos con tarjeta procesados de forma segura</li>
                    <li>Mercado Pago te redirige a su plataforma</li>
                    <li>Recibirás un comprobante al aprobarse el pago</li>
                </ul>
            </div>

        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        const turnoId = @turno.Id;

        // Mostrar campos adicionales según el método de pago seleccionado
        document.getElementById('MetodoPago').addEventListener('change', function() {
            const metodoPago = parseInt(this.value);
            const camposTarjeta = document.getElementById('camposTarjeta');
            const campoTransaccion = document.getElementById('campoTransaccion');

            camposTarjeta.style.display = 'none';
            campoTransaccion.style.display = 'none';

            if (metodoPago === 1 || metodoPago === 2) { // Tarjeta
                camposTarjeta.style.display = 'block';
            } else if (metodoPago === 4) { // Transferencia
                campoTransaccion.style.display = 'block';
            }
        });

        // Procesar el formulario
        document.getElementById('formPago').addEventListener('submit', function(e) {
            e.preventDefault();
            const metodoPago = parseInt(document.getElementById('MetodoPago').value);

            if (isNaN(metodoPago) || metodoPago < 0) {
                Swal.fire('Error', 'Debe seleccionar un método de pago', 'error');
                return;
            }

            if (metodoPago === 3) { // Mercado Pago
                procesarConMercadoPago();
                return;
            }

            Swal.fire({
                title: '¿Confirmar pago?',
                html: `Está por realizar un pago de <strong>$@turno.Precio.ToString("N2")</strong>`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#6c757d',
                confirmButtonText: 'Sí, confirmar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    procesarPagoNormal();
                }
            });
        });

        function procesarConMercadoPago() {
            Swal.fire({
                title: 'Redirigiendo a Mercado Pago...',
                html: 'Por favor espere mientras creamos tu preferencia de pago',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => Swal.showLoading()
            });

            fetch('/Pago/CrearPreferenciaMercadoPago', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ turnoId: turnoId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok && data.initPoint) {
                    window.location.href = data.initPoint;
                } else {
                    Swal.fire('Error', data.message || 'No se pudo conectar con Mercado Pago', 'error');
                }
            })
            .catch(() => Swal.fire('Error', 'Ocurrió un error al conectar con Mercado Pago', 'error'));
        }

        function procesarPagoNormal() {
            Swal.fire({
                title: 'Procesando pago...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                allowEscapeKey: false,
                showConfirmButton: false,
                didOpen: () => Swal.showLoading()
            });

            const formData = new FormData(document.getElementById('formPago'));

            fetch('/Pago/Procesar', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Pago Exitoso!',
                        text: data.message,
                        confirmButtonText: 'Ver Comprobante'
                    }).then(() => {
                        window.location.href = '/Pago/Comprobante/' + data.pagoId;
                    });
                } else {
                    Swal.fire('Error', data.message, 'error');
                }
            })
            .catch(() => Swal.fire('Error', 'Ocurrió un error al procesar el pago', 'error'));
        }
    </script>
}
