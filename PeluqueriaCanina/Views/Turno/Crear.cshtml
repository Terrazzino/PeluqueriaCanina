@model PeluqueriaCanina.Models.ClasesDeTurno.Turno

@{
    ViewData["Title"] = "Reservar Turno";
}

<div class="card shadow-sm mt-4">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0">📅 Reservar Turno</h4>
    </div>
    <div class="card-body">
        <form asp-action="Crear" method="post">
            <div class="form-group">
                <label>Mascota</label>
                <select asp-for="MascotaId" class="form-control" required>
                    <option value="">Seleccione una mascota</option>
                    @foreach (var mascota in ViewBag.Mascotas)
                    {
                        <option value="@mascota.Id">@mascota.Nombre</option>
                    }
                </select>
            </div>

            <div class="form-group mt-2">
                <label>Servicio</label>
                <select id="ServicioId" asp-for="ServicioId" class="form-control" required>
                    <option value="">Seleccione un servicio</option>
                    @foreach (var servicio in ViewBag.Servicios)
                    {
                        <option value="@servicio.Id">@servicio.NombreDelServicio</option>
                    }
                </select>
            </div>

            <div class="form-group mt-2">
                <label>Peluquero</label>
                <select id="PeluqueroId" asp-for="PeluqueroId" class="form-control">
                    <option value="">Cualquiera</option>
                    @foreach (var peluquero in ViewBag.Peluqueros)
                    {
                        <option value="@peluquero.Id">@peluquero.Nombre</option>
                    }
                </select>
            </div>

            <!-- Campo oculto donde guardamos la fecha seleccionada -->
            <input type="hidden" asp-for="FechaHora" id="FechaHora" />

            <div class="mt-4">
                <div id="calendar"></div>
            </div>

            <button type="submit" class="btn btn-success mt-3">Confirmar Turno</button>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                allDaySlot: false,
                slotDuration: '00:30:00',
                slotMinTime: "09:00:00",
                slotMaxTime: "18:00:00",
                locale: 'es',
                selectable: true,
                nowIndicator: true,
                events: function (fetchInfo, successCallback, failureCallback) {
                    const servicioId = document.getElementById("ServicioId").value;
                    const peluqueroId = document.getElementById("PeluqueroId").value;

                    if (!servicioId) {
                        successCallback([]);
                        return;
                    }

                    $.getJSON('@Url.Action("GetDisponibilidad", "Turno")', {
                        servicioId: servicioId,
                        peluqueroId: peluqueroId,
                        start: fetchInfo.startStr,
                        end: fetchInfo.endStr
                    }).done(function (data) {
                        successCallback(data);
                    });
                },
                eventClick: function (info) {
                    if (info.event.title === "Disponible") {
                        document.getElementById("FechaHora").value = info.event.startStr;
                        alert("Turno elegido: " + info.event.start.toLocaleString());
                    }
                }
            });

            calendar.render();

            // Recargar eventos al cambiar servicio o peluquero
            document.getElementById("ServicioId").addEventListener("change", function () {
                calendar.refetchEvents();
            });
            document.getElementById("PeluqueroId").addEventListener("change", function () {
                calendar.refetchEvents();
            });
        });
    </script>
}
