@model PeluqueriaCanina.Models.ClasesDeTurno.Turno

@{
    ViewData["Title"] = "Reservar Turno";
}

<div class="card shadow-sm mt-4">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0">📅 Reservar Turno</h4>
    </div>
    <div class="card-body">
        <form asp-action="Crear" method="post">
            @Html.AntiForgeryToken()

            <div asp-validation-summary="All" class="text-danger"></div>

            <!-- Mascota -->
            <div class="mb-3">
                <label for="mascotaId" class="form-label">Mascota</label>
                <select id="mascotaId" name="MascotaId" class="form-select" required>
                    <option value="">Seleccione una mascota</option>
                    @{
                        var mascotas = ViewBag.Mascotas as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
                    }
                    @foreach (var m in mascotas)
                    {
                        <option value="@m.Id">@m.Nombre</option>
                    }
                </select>
            </div>

            <!-- Servicio -->
            <div class="mb-3">
                <label for="servicioId" class="form-label">Servicio</label>
                <select id="servicioId" name="ServicioId" class="form-select" required>
                    <option value="">Seleccione un servicio</option>
                    @{
                        var servicios = ViewBag.Servicios as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
                    }
                    @foreach (var s in servicios)
                    {
                        <option value="@s.Id" data-duracion="@((s.Duracion != null) ? s.Duracion.TotalMinutes : 30)">
                            @((s.NombreDelServicio ?? s.Nombre) ?? "Servicio")
                        </option>
                    }
                </select>
            </div>

            <!-- Peluquero -->
            <div class="mb-3">
                <label for="peluqueroId" class="form-label">Peluquero (opcional)</label>
                <select id="peluqueroId" name="PeluqueroId" class="form-select">
                    <option value="">Cualquiera</option>
                    @{
                        var peluqueros = ViewBag.Peluqueros as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
                    }
                    @foreach (var p in peluqueros)
                    {
                        <option value="@p.Id">@p.Nombre @((p.Apellido ?? ""))</option>
                    }
                </select>
            </div>

            <input type="hidden" id="FechaHora" name="FechaHora" />

            <div class="mt-4">
                <div id="calendar" style="min-height:400px;border:1px solid #ddd;"></div>
            </div>

            <button type="submit" class="btn btn-success mt-3">Confirmar Turno</button>
        </form>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                allDaySlot: false,
                slotDuration: '00:30:00',
                slotMinTime: "09:00:00",
                slotMaxTime: "18:00:00",
                locale: 'es',
                selectable: true,
                nowIndicator: true,
                events: function (fetchInfo, successCallback) {
                    const servicioId = document.getElementById("servicioId").value;
                    const peluqueroId = document.getElementById("peluqueroId").value;
                    if (!servicioId) { successCallback([]); return; }

                    $.getJSON('@Url.Action("GetDisponibilidad", "Turno")', {
                        servicioId: servicioId,
                        peluqueroId: peluqueroId,
                        start: fetchInfo.startStr,
                        end: fetchInfo.endStr
                    }).done(function (data) {
                        successCallback(data);
                    }).fail(function () {
                        successCallback([]);
                    });
                },
                eventClick: function (info) {
                    if (info.event.title === "Disponible") {
                        document.getElementById("FechaHora").value = info.event.startStr;
                        // marcar seleccionado visualmente
                        calendar.getEvents().forEach(e => {
                            if (e.title === "Disponible") e.setProp("backgroundColor", "#28a745");
                        });
                        info.event.setProp("backgroundColor", "#007bff");
                    }
                }
            });

            calendar.render();

            document.getElementById("servicioId").addEventListener("change", function () {
                calendar.refetchEvents();
            });
            document.getElementById("peluqueroId").addEventListener("change", function () {
                calendar.refetchEvents();
            });
        });
        document.querySelector("form").addEventListener("submit", function (e) {
            const mascota = document.getElementById("mascotaId").value;
            const servicio = document.getElementById("servicioId").value;
            const fechaHora = document.getElementById("FechaHora").value;

            if (!mascota || !servicio || !fechaHora) {
                e.preventDefault();
                alert("Debe seleccionar una mascota, un servicio y un horario antes de confirmar el turno.");
            }
        });

    </script>
}
