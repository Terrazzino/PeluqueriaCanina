@model PeluqueriaCanina.Models.ClasesDeTurno.Turno

@{
    ViewData["Title"] = "Reservar Turno";
}

<div class="glass-card mt-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary fw-semibold">Nuevo Turno</h2>
        <a asp-controller="Cliente" asp-action="Dashboard" class="btn-outline">Volver al Inicio</a>
    </div>

    <!-- Paso 1: Seleccionar Turno -->
    <div class="card-step" id="paso1">
        <div class="card-header bg-primary text-white fw-semibold">
            Paso 1: Seleccionar Turno
        </div>
        <div class="card-body">
            <form id="formTurno">
                @Html.AntiForgeryToken()

                <!-- Mascota -->
                <div class="mb-3">
                    <label for="mascotaId" class="form-label">Mascota *</label>
                    <select id="mascotaId" name="MascotaId" class="form-select" required>
                        <option value="">Seleccione una mascota</option>
                        @{
                            var mascotas = ViewBag.Mascotas as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
                        }
                        @foreach (var m in mascotas)
                        {
                            <option value="@m.Id">@m.Nombre</option>
                        }
                    </select>
                </div>

                <!-- Servicio -->
                <div class="mb-3">
                    <label for="servicioId" class="form-label">Servicio *</label>
                    <select id="servicioId" name="ServicioId" class="form-select" required>
                        <option value="">Seleccione un servicio</option>
                        @{
                            var servicios = ViewBag.Servicios as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
                        }
                        @foreach (var s in servicios)
                        {
                            <option value="@s.Id"
                                    data-duracion="@((s.Duracion != null) ? s.Duracion.TotalMinutes : 30)"
                                    data-precio="@s.Precio">
                                @((s.NombreDelServicio ?? s.Nombre) ?? "Servicio") - $@s.Precio
                            </option>
                        }
                    </select>
                </div>

                <!-- Peluquero -->
                <div class="mb-3">
                    <label for="peluqueroId" class="form-label">Peluquero (opcional)</label>
                    <select id="peluqueroId" name="PeluqueroId" class="form-select">
                        <option value="">Cualquiera</option>
                        @{
                            var peluqueros = ViewBag.Peluqueros as IEnumerable<dynamic> ?? Enumerable.Empty<dynamic>();
                        }
                        @foreach (var p in peluqueros)
                        {
                            <option value="@p.Id">@p.Nombre @((p.Apellido ?? ""))</option>
                        }
                    </select>
                </div>

                <input type="hidden" id="FechaHora" name="FechaHora" />

                <!-- Calendario -->
                <div class="mb-3">
                    <label class="form-label">Seleccionar Horario *</label>
                    <div id="calendar" class="calendar-container"></div>
                </div>

                <!-- Resumen -->
                <div class="alert-info mt-3 p-3 rounded" id="resumenTurno" style="display:none;">
                    <h5 class="fw-semibold mb-2">Resumen de tu reserva</h5>
                    <p><strong>Mascota:</strong> <span id="resumenMascota">-</span></p>
                    <p><strong>Servicio:</strong> <span id="resumenServicio">-</span></p>
                    <p><strong>Fecha y Hora:</strong> <span id="resumenFechaHora">-</span></p>
                    <p><strong>Peluquero:</strong> <span id="resumenPeluquero">Cualquiera disponible</span></p>
                    <hr>
                    <h4 class="text-end mb-0"><strong>Total:</strong> <span class="text-success">$<span id="resumenPrecio">0</span></span></h4>
                </div>

                <button type="button" class="btn btn-primary w-100 mt-3" id="btnContinuarPago">Continuar al Pago</button>
            </form>
        </div>
    </div>

    <!-- Paso 2: Pago -->
    <div class="card-step mt-4" id="paso2" style="display:none;">
        <div class="card-header bg-success text-white fw-semibold">
            Paso 2: Confirmar Pago
        </div>
        <div class="card-body">
            <form id="formPago">
                @Html.AntiForgeryToken()
                <input type="hidden" id="pagoTurnoId" name="TurnoId" />
                <input type="hidden" id="pagoMonto" name="Monto" />

                <!-- Resumen de pago -->
                <div class="alert-secondary mb-3 p-3 rounded">
                    <h5 class="fw-semibold mb-2">Resumen de Pago</h5>
                    <div class="d-flex justify-content-between">
                        <div>
                            <p><strong>Servicio:</strong> <span id="pagoResumenServicio">-</span></p>
                            <p><strong>Mascota:</strong> <span id="pagoResumenMascota">-</span></p>
                            <p><strong>Fecha:</strong> <span id="pagoResumenFecha">-</span></p>
                        </div>
                        <h3 class="text-success">$<span id="pagoResumenPrecio">0</span></h3>
                    </div>
                </div>

                <!-- Método de Pago -->
                <div class="mb-3">
                    <label for="MetodoPago" class="form-label">Método de Pago *</label>
                    <select id="MetodoPago" name="MetodoPago" class="form-select" required>
                        <option value="">Seleccione un método</option>
                        <option value="0">Efectivo</option>
                        <option value="1">Tarjeta de Débito</option>
                        <option value="2">Tarjeta de Crédito</option>
                        <option value="3">Mercado Pago</option>
                        <option value="4">Transferencia Bancaria</option>
                    </select>
                </div>

                <!-- Campos adicionales -->
                <div id="camposTarjeta" class="mb-3" style="display:none;">
                    <label for="Ultimos4Digitos" class="form-label">Últimos 4 dígitos de la tarjeta</label>
                    <input type="text" id="Ultimos4Digitos" name="Ultimos4Digitos" class="form-control" maxlength="4" pattern="\d{4}" placeholder="1234">
                    <small class="text-muted">Solo para referencia</small>
                </div>

                <div id="campoTransaccion" class="mb-3" style="display:none;">
                    <label for="NumeroTransaccion" class="form-label">Número de Transacción / Comprobante</label>
                    <input type="text" id="NumeroTransaccion" name="NumeroTransaccion" class="form-control" maxlength="100" placeholder="Ej: MP-12345678">
                </div>

                <div class="mb-3">
                    <label for="Observaciones" class="form-label">Observaciones (opcional)</label>
                    <textarea id="Observaciones" name="Observaciones" class="form-control" rows="3" maxlength="500" placeholder="Notas adicionales"></textarea>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success btn-lg">Confirmar Reserva y Pago</button>
                    <button type="button" class="btn btn-outline-secondary" id="btnVolverTurno">Volver al Paso 1</button>
                </div>
            </form>
        </div>
    </div>

</div>

<style>
    .glass-card {
        background: rgba(28,28,28,0.85);
        backdrop-filter: blur(10px);
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        color: #f0f0f0;
    }

    .card-step {
        border-radius: 12px;
        overflow: hidden;
    }

    .card-header {
        font-size: 1.1rem;
    }

    .alert-info {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 1rem;
    }

    .alert-secondary {
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
        padding: 1rem;
    }

    .btn-outline {
        padding: 0.4rem 0.8rem;
        border-radius: 8px;
        border: 1px solid #f0f0f0;
        color: #f0f0f0;
        font-weight: 500;
        transition: 0.2s;
    }

        .btn-outline:hover {
            background: #f0f0f0;
            color: #1c1c1c;
        }

    .calendar-container {
        min-height: 400px;
        border-radius: 8px;
        overflow: hidden;
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        let calendar;
        let turnoTemporal = null;

        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                allDaySlot: false,
                slotDuration: '00:30:00',
                slotMinTime: "07:00:00",
                slotMaxTime: "22:00:00",
                locale: 'es',
                selectable: true,
                nowIndicator: true,
                validRange: { start: new Date() },
                events: function(fetchInfo, successCallback) {
                    const servicioId = document.getElementById("servicioId").value;
                    const peluqueroId = document.getElementById("peluqueroId").value;
                    if (!servicioId) { successCallback([]); return; }

                    $.getJSON('@Url.Action("GetDisponibilidad", "Turno")', {
                        servicioId: servicioId,
                        peluqueroId: peluqueroId,
                        start: fetchInfo.startStr,
                        end: fetchInfo.endStr
                    }).done(successCallback).fail(() => successCallback([]));
                },
                eventClick: function(info) {
                    if (info.event.title === "Disponible") {
                        document.getElementById("FechaHora").value = info.event.startStr;
                        calendar.getEvents().forEach(e => {
                            if (e.title === "Disponible") e.setProp("backgroundColor", "#28a745");
                        });
                        info.event.setProp("backgroundColor", "#007bff");
                        actualizarResumen();
                    }
                }
            });

            calendar.render();

            document.getElementById("servicioId").addEventListener("change", () => { calendar.refetchEvents(); actualizarResumen(); });
            document.getElementById("peluqueroId").addEventListener("change", () => { calendar.refetchEvents(); actualizarResumen(); });
            document.getElementById("mascotaId").addEventListener("change", actualizarResumen);

            document.getElementById("btnContinuarPago").addEventListener("click", function() {
                const mascota = document.getElementById("mascotaId").value;
                const servicio = document.getElementById("servicioId").value;
                const fechaHora = document.getElementById("FechaHora").value;

                if (!mascota || !servicio || !fechaHora) {
                    Swal.fire({ icon: "warning", title: "Faltan datos", text: "Debes seleccionar mascota, servicio y horario." });
                    return;
                }

                Swal.fire({ title: 'Creando turno...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                $.ajax({
                    url: "@Url.Action("Crear", "Turno")",
                    type: "POST",
                    data: $("#formTurno").serialize(),
                    success: function(response) {
                        Swal.close();
                        if (response.ok) {
                            turnoTemporal = {
                                id: response.turnoId,
                                mascota: document.getElementById("mascotaId").selectedOptions[0].text,
                                servicio: document.getElementById("servicioId").selectedOptions[0].text.split(' - ')[0],
                                fecha: new Date(fechaHora).toLocaleDateString('es-AR'),
                                hora: new Date(fechaHora).toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'}),
                                precio: document.getElementById("servicioId").selectedOptions[0].getAttribute('data-precio')
                            };
                            document.getElementById("pagoTurnoId").value = response.turnoId;
                            document.getElementById("pagoMonto").value = turnoTemporal.precio;
                            document.getElementById("pagoResumenServicio").textContent = turnoTemporal.servicio;
                            document.getElementById("pagoResumenMascota").textContent = turnoTemporal.mascota;
                            document.getElementById("pagoResumenFecha").textContent = turnoTemporal.fecha + ' ' + turnoTemporal.hora;
                            document.getElementById("pagoResumenPrecio").textContent = turnoTemporal.precio;
                            mostrarPaso2();
                        } else {
                            Swal.fire({ icon: "error", title: "No se pudo crear el turno", text: response.message });
                        }
                    },
                    error: function() {
                        Swal.close();
                        Swal.fire({ icon: "error", title: "Error del servidor", text: "Ocurrió un problema al crear el turno." });
                    }
                });
            });

            document.getElementById("btnVolverTurno").addEventListener("click", mostrarPaso1);

            document.getElementById('MetodoPago').addEventListener('change', function() {
                const metodo = parseInt(this.value);
                document.getElementById('camposTarjeta').style.display = (metodo === 1 || metodo === 2) ? 'block' : 'none';
                document.getElementById('campoTransaccion').style.display = (metodo === 3 || metodo === 4) ? 'block' : 'none';
            });

            function mostrarPaso2() {
                document.getElementById("paso1").style.display = "none";
                document.getElementById("paso2").style.display = "block";
                window.scrollTo({ top:0, behavior:'smooth' });
            }

            function mostrarPaso1() {
                document.getElementById("paso2").style.display = "none";
                document.getElementById("paso1").style.display = "block";
                window.scrollTo({ top:0, behavior:'smooth' });
            }

            function actualizarResumen() {
                const mascotaSel = document.getElementById("mascotaId");
                const servicioSel = document.getElementById("servicioId");
                const peluqueroSel = document.getElementById("peluqueroId");
                const fechaHora = document.getElementById("FechaHora").value;

                if (mascotaSel.value && servicioSel.value && fechaHora) {
                    document.getElementById("resumenTurno").style.display = "block";
                    document.getElementById("resumenMascota").textContent = mascotaSel.selectedOptions[0].text;
                    document.getElementById("resumenServicio").textContent = servicioSel.selectedOptions[0].text.split(' - ')[0];
                    const fecha = new Date(fechaHora);
                    document.getElementById("resumenFechaHora").textContent = fecha.toLocaleDateString('es-AR') + ' ' +
                        fecha.toLocaleTimeString('es-AR', {hour:'2-digit', minute:'2-digit'});
                    document.getElementById("resumenPeluquero").textContent = peluqueroSel.value ? peluqueroSel.selectedOptions[0].text : "Cualquiera disponible";
                    document.getElementById("resumenPrecio").textContent = servicioSel.selectedOptions[0].getAttribute('data-precio');
                } else {
                    document.getElementById("resumenTurno").style.display = "none";
                }
            }
        });
    </script>
}
